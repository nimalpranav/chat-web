<!DOCTYPE html>
<html>
<head>
  <title>Private Chat</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family:'Segoe UI',Arial,sans-serif; background:linear-gradient(135deg,#667eea,#764ba2); padding:20px; color:#fff; display:flex; flex-direction:column; align-items:center; }
    h2 { margin-bottom:10px; text-shadow:1px 1px 3px rgba(0,0,0,.4); }
    #pinned { width:80%; max-width:700px; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.2); display:none; margin-bottom:8px; }
    #topbar { width:80%; max-width:700px; display:flex; gap:10px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    #online { flex:1; background:rgba(255,255,255,.18); border-radius:10px; padding:8px; min-height:40px; }
    #lockBanner { display:none; background:#ff7979; color:#fff; padding:6px 10px; border-radius:8px; }
    #messages { width:80%; max-width:700px; height:350px; overflow-y:auto; background:rgba(255,255,255,.15); backdrop-filter:blur(8px); border-radius:15px; padding:15px; box-shadow:0 4px 20px rgba(0,0,0,.2); margin-bottom:10px; }
    .msg { display:flex; align-items:center; justify-content:space-between; background:rgba(255,255,255,.25); backdrop-filter:blur(4px); padding:10px; border-radius:10px; margin-bottom:8px; }
    .thumb img, .thumb video { max-width:200px; border-radius:10px; }
    .delete-btn { background:linear-gradient(135deg,#ff4d4d,#cc0000); border:none; color:#fff; border-radius:50%; width:30px; height:30px; cursor:pointer; }
    button { cursor:pointer; border:none; background:linear-gradient(135deg,#ff4d4d,#ff9900); color:white; padding:8px 14px; border-radius:20px; font-weight:bold; }
    input[type="text"], input[type="file"], select { padding:10px; border-radius:8px; border:none; outline:none; background:rgba(255,255,255,.8); }
    .input-area { display:flex; width:80%; max-width:700px; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h2>üí¨ Private Chat</h2>

  <div id="pinned"></div>

  <div id="topbar">
    <div>
      <input id="username" type="text" placeholder="Enter your name..." style="width:220px;">
      <button id="setNameBtn">Set name</button>
    </div>
    <div>
      <label>DM:</label>
      <select id="userList"><option value="">(nobody)</option></select>
      <input type="checkbox" id="dmToggle"> Private
    </div>
    <div id="lockBanner">üîí Chat is locked by admin</div>
    <div id="online"></div>
  </div>

  <div id="messages"></div>

  <div class="input-area">
    <input id="myMessage" type="text" placeholder="Type a message..." style="flex:1;">
    <button id="sendBtn">Send</button>
    <input type="file" id="fileInput">
    <button id="fileBtn">üìé Send File</button>
  </div>
{% for message in messages %}
<div>
    <b>{{ message.username }}</b>: {{ message.text }}
    <form method="POST" action="/delete/{{ message.id }}" style="display:inline;">
        <button type="submit">Delete</button>
    </form>
</div>
{% endfor %}

  <script>
    const socket = io();
    const username = "{{ username }}";   // from Flask session
    const isAdmin = "{{ 'true' if is_admin else 'false' | safe}}";
    const messagesDiv = document.getElementById('messages');
    const usernameInput = document.getElementById('username');
    const setNameBtn = document.getElementById('setNameBtn');
    const userList = document.getElementById('userList');
    const dmToggle = document.getElementById('dmToggle');
    const pinnedDiv = document.getElementById('pinned');
    const lockBanner = document.getElementById('lockBanner');
    const sendBtn = document.getElementById('sendBtn');

    // Load history
    fetch('/messages').then(r=>r.json()).then(list=>{
      list.forEach(msg=>{
        if (msg.type === 'text') addTextMessage(msg.username, msg.text, msg.id, msg.dm);
        else if (msg.type === 'file') addFileMessage(msg.filename, msg.url, msg.id, msg.username);
      });
    });

function renderMessage(msg) {
    let div = document.createElement("div");
    div.innerHTML = `
        <b>${msg.username}:</b> ${msg.text || ""}
        ${msg.type === "file" ? `<a href="${msg.url}" target="_blank">${msg.filename}</a>` : ""}
        {% if is_admin %}
        <form method="POST" action="/admin/delete/${msg.id}" style="display:inline;">
            <button type="submit">‚ùå Delete</button>
        </form>
        {% endif %}
    `;
    div.id = "msg-" + msg.id;
    document.getElementById("messages").appendChild(div);
}

// listen for server delete events
socket.on("delete_message", function(id) {
    let el = document.getElementById("msg-" + id);
    if (el) el.remove();
});


 function addMessage(msgId, user, text) {
        const messagesDiv = document.getElementById("messages");

        let msgDiv = document.createElement("div");
        msgDiv.id = "msg-" + msgId;
        msgDiv.innerHTML = `<b>${user}:</b> ${text}`;

        if (isAdmin) {
            let delBtn = document.createElement("button");
            delBtn.innerText = "Delete";
            delBtn.onclick = function() {
                fetch(`/delete/${msgId}`, { method: "POST" })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById("msg-" + msgId).remove();
                        }
                    });
            };
            msgDiv.appendChild(delBtn);
        }

        messagesDiv.appendChild(msgDiv);
    }


    // --- username / online users ---
    function setUsername(){
      const u = usernameInput.value.trim() || "no name";
      socket.emit('set_username', {username: u});
    }
    setNameBtn.onclick = setUsername;
    // set name once after small delay (user can change later)
    setTimeout(setUsername, 400);

    socket.on('online_users', (users)=>{
      const me = usernameInput.value.trim();
      userList.innerHTML = '<option value="">(nobody)</option>' +
        users.filter(u=>u!==me).map(u=>`<option>${escapeHtml(u)}</option>`).join('');
      document.getElementById('online').innerHTML = 'Online: ' + (users.join(', ') || '<i>none</i>');
    });

    // --- pinned message ---
    socket.on('pinned', (pin)=>{
      if (!pin){ pinnedDiv.style.display='none'; pinnedDiv.textContent=''; return; }
      pinnedDiv.style.display='block';
      pinnedDiv.textContent = `üìå ${pin.text}`;
    });

    // --- lock state / mute state ---
    let mutedUntil = 0;
    socket.on('lock_state', ({locked})=>{
      lockBanner.style.display = locked ? 'inline-block' : 'none';
      sendBtn.disabled = locked;
    });
    socket.on('muted', ({until})=>{
      mutedUntil = until || 0;
      alert(until && until > Date.now()/1000 ? 'You have been muted.' : 'You are unmuted.');
    });

    // --- system messages (info) ---
    socket.on('system', ({text})=>{
      addRow('sys-'+Date.now(), `<em>${escapeHtml(text)}</em>`);
    });

    // --- chat events ---
    socket.on('message', function(data) {
      addTextMessage(data.username, data.text, data.id, data.dm);
    });
    socket.on('file_message', function(data) {
      addFileMessage(data.filename, data.url, data.id, data.username);
    });
    socket.on('delete_message', function(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    });

    // --- send message / file ---
    sendBtn.onclick = sendMessage;
    document.getElementById('myMessage').addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      if (mutedUntil && mutedUntil > Date.now()/1000) { alert('You are muted.'); return; }
      const input = document.getElementById('myMessage');
      const username = usernameInput.value.trim() || "no name";
      const val = input.value.trim();
      if (!val) return;
      const dmUser = (dmToggle.checked ? (userList.value || '') : '');
      socket.send({ username: username, text: val, to: dmUser });
      input.value = '';
    }

    document.getElementById('fileBtn').onclick = sendFile;
    function sendFile() {
      const fileInput = document.getElementById('fileInput');
      const username = usernameInput.value.trim() || "no name";
      if (fileInput.files.length > 0) {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('username', username);
        fetch('/upload', { method: 'POST', body: formData });
        fileInput.value = '';
      }
    }

    // --- helpers/UI ---
    function addRow(id, htmlContent) {
  const row = document.createElement('div');
  row.className = 'msg';
  row.id = id;

  const content = document.createElement('div');
  content.className = 'thumb';
  content.innerHTML = htmlContent;

  row.appendChild(content);

  // Only show delete button if admin
  if (isAdmin === "true") {
    const del = document.createElement('button');
    del.className = 'delete-btn';
    del.textContent = '‚ùå';
    del.title = 'Delete (admin only)';
    del.onclick = () => socket.emit('delete_message', id);
    row.appendChild(del);
  }

  messagesDiv.appendChild(row);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

    function addTextMessage(username, text, id, dmTo) {
      const tag = dmTo ? ` <span style="background:#0003;padding:2px 6px;border-radius:8px;">DM ‚Üí ${escapeHtml(dmTo)}</span>` : '';
      addRow(id, `<strong>${escapeHtml(username)}:</strong>${tag} ${escapeHtml(text)}`);
    }

    function addFileMessage(filename, url, id, username) {
      const ext = (filename.split('.').pop() || '').toLowerCase();
      let html = `<strong>${escapeHtml(username)}:</strong><br>`;
      if (['png','jpg','jpeg','gif','webp'].includes(ext)) html += `<img src="${url}" alt="${escapeAttr(filename)}">`;
      else if (['mp4','webm'].includes(ext)) html += `<video src="${url}" controls></video>`;
      else if (['mp3','wav','ogg'].includes(ext)) html += `<audio controls src="${url}"></audio>`;
      else if (ext === 'pdf') html += `<iframe src="${url}" style="width:200px;height:150px;border-radius:10px;"></iframe>`;
      else html += `<a href="${url}" target="_blank" rel="noopener">${escapeHtml(filename)}</a>`;
      addRow(id, html);
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function escapeAttr(s){ return (s||'').replace(/"/g, '&quot;'); }
  </script>
</body>
</html>
